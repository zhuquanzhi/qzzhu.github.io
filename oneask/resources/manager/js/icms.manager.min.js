var ICMS = {};
ICMS.system={},ICMS.security={},ICMS.setsystem={},ICMS.business={},ICMS.business.article={};
ICMS.login = function(form, ctx) {
	form = $(form);
	form.find("input[type!='submit']").focusin(function() {
		this_item = $(this);
		if (this_item.attr("id") == "username") {
			this_item.siblings('label').hide();
		}
		if (this_item.attr("id") == "password") {
			this_item.siblings('label').hide();
		}
	}).blur(function() {
		this_item = $(this);
		if (this_item.attr("id") == "username") {
			if (ICMS.isnull(this_item.val())) {
				this_item.siblings('label').show();
			}
		}
		if (this_item.attr("id") == "password") {
			if (ICMS.isnull(this_item.val())) {
				this_item.siblings('label').show();
			}
		}
	});
};
ICMS.isnull = function(input_value) {
	input_value = $.trim(input_value);
	if (input_value == "") {
		return true;
	} else {
		return false;
	}
};
ICMS.select = function() {
	var selectItems = [];
	$(':checkbox[name="items"][checked]').each(function() {
		selectItems.push($(this).val());
	});
	return selectItems;
};
ICMS.selectAll = function() {
	/**$(':checkbox[name="items"]').attr('checked', true);**/
	/*use uniform js do*/
	$(':checkbox[name="items"]').prop('checked',true);
	$.uniform.update(':checkbox[name="items"]');
};
ICMS.unselectAll = function() {
	/**$(':checkbox[name="items"]').attr('checked', false);**/
	$(':checkbox[name="items"]').prop('checked',false);
	$.uniform.update(':checkbox[name="items"]');
};
ICMS.search = function() {
	$('#myForm').attr("method", "get").submit();
};
ICMS.jumpPage = function(pageNo) {
	$("#pageNo").val(pageNo);
	$("#myForm").attr("method", "get");
	$("#myForm").submit();
};
ICMS.date2string = function(date, format) {
	var o = {
		"M+" : date.getMonth() + 1,
		"d+" : date.getDate(),
		"h+" : date.getHours(),
		"m+" : date.getMinutes(),
		"s+" : date.getSeconds(),
		"q+" : Math.floor((date.getMonth() + 3) / 3),
		"S" : date.getMilliseconds()
	};
	if (/(y+)/.test(format)) {
		format = format.replace(RegExp.$1, (date.getFullYear() + "")
				.substr(4 - RegExp.$1.length));
	}
	for ( var k in o) {
		if (new RegExp("(" + k + ")").test(format)) {
			format = format.replace(RegExp.$1, RegExp.$1.length == 1 ? o[k]
					: ("00" + o[k]).substr(("" + o[k]).length));
		}
	}
	return format;
};
ICMS.long2date = function(dateAsLong) {
	var date = new Date(parseInt(dateAsLong, 10));
	var year = date.getFullYear();
	var month = date.getMonth() + 1;
	month = month >= 10 ? month.toString() : ("0" + month);
	var day = date.getDate() >= 10 ? date.getDate() : ("0" + date.getDate());
	var hours = date.getHours() >= 10 ? date.getHours().toString()
			: ("0" + date.getHours());
	var minutes = date.getMinutes() >= 10 ? date.getMinutes().toString()
			: ("0" + date.getMinutes());
	var seconds = date.getSeconds() >= 10 ? date.getSeconds().toString()
			: ("0" + date.getSeconds());
	return "".concat(year, "-", month, "-", day, " ", hours, ":", minutes, ":",
			seconds);
};
var kbytes = 1024;
var mbytes = 1024 * 1024;
var gbytes = 1024 * 1024 * 1024;
ICMS.formatFileSize = function(fileSize) {
	if (fileSize > gbytes) {
		return ICMS.round((fileSize / gbytes), 1) + "G";
	}
	if (fileSize > mbytes) {
		return ICMS.round((fileSize / mbytes), 1) + "M";
	}
	if (fileSize > kbytes) {
		return ICMS.round((fileSize / kbytes), 1) + "K";
	}
	return fileSize + "bytes";
};
ICMS.round = function(val, scale) {
	var valAsString = val.toString();
	var scaleOnVal = 0;
	try {
		scaleOnVal = valAsString.split(".")[1].length;
	} catch (e) {
	}
	if (scaleOnVal === 0) {
		return valAsString;
	}
	if (scale >= scaleOnVal) {
		return valAsString;
	}
	var length = valAsString.length;
	return valAsString.slice(0, length - (scaleOnVal - scale));
};

$(function() {
	$("#select_all").click(function() {
		ICMS.selectAll();
	});
	$("#unselect_all").click(function() {
		ICMS.unselectAll();
	});
	$("#search").click(function() {
		ICMS.search();
	});
	$(".date").each(function() {
		var $this = $(this);
		var lastModified = $this.text();
		$this.empty().append(ICMS.long2date(lastModified));
	});
	$(".fileSize").each(function() {
		var $this = $(this);
		var fileSize = $this.text();
		$this.empty().append(ICMS.formatFileSize(fileSize));
	});
});

ICMS.product_crud= function() {
	var ajaxurl = {			
			loadProvinceURL : '/manager/setsystem/ajax/loadProvince?areaid=',
			loadCityURL: '/manager/setsystem/ajax/loadCity?provinceid='
	};
	return {		
		ready : function(){			
			$(".search_submit_form").validationEngine();
			$(".myform").validationEngine();
			return this;
		},
		choose_where: function(local){			
			$(".area").change(function(){
				$.getJSON(local+ajaxurl.loadProvinceURL+$(this).children('option:selected').val(), function(data){
					if(data != null && data.length > 0){
						$(".province").empty().append("<option value=''>请选择省份</option>");
						$(".city").empty().append("<option value=''>请选择城市</option>");
						$.each(data, function(i,item){
							$("<option value='"+item.id+"'>"+item.name+"</option>").appendTo(".province");
							//$('#sharing_city_modal').find('#'+item.city_id).attr("checked",true).parent().addClass('checked');
						});
					}else{
						$(".province").empty().append("<option value=''>请选择省份</option>");
						$(".city").empty().append("<option value=''>请选择城市</option>");
					}
				});
			});
			$(".province").change(function(){
				$.getJSON(local+ajaxurl.loadCityURL+$(this).children('option:selected').val(), function(data){
					if(data != null && data.length > 0){
						$(".city").empty().append("<option value=''>请选择城市</option>");
						$.each(data, function(i,item){
							$("<option value='"+item.id+"'>"+item.name+"</option>").appendTo(".city");
							//$('#sharing_city_modal').find('#'+item.city_id).attr("checked",true).parent().addClass('checked');
						});
					}else{
						$(".city").empty().append("<option value=''>请选择城市</option>");
					}
				});
			});
			return this;
		},
		edit: function(){
			$(".picture-box").on("click", ".set-picture-header", function(c) {
				c.preventDefault();
				var self = $(this);
				self.parents(".picture-box").find(".set-picture-header").each(function() {
					$(this).removeClass("picture-header").text("设置为列表页封面")
				});				
				self.addClass("picture-header").text("已设置为封面");
				$("#coverImage").val(self.data("value"));
			}),$("a[rel='delete-picture']").live("click", function(c) {
				$(this).parents("li").remove();
			});
			return this;
		},
		add: function(){
			$(".picture-box").on("click", ".set-picture-header", function(c) {
				c.preventDefault();
				var self = $(this);
				self.parents(".picture-box").find(".set-picture-header").each(function() {
					$(this).removeClass("picture-header").text("设置为列表页封面")
				});				
				self.addClass("picture-header").text("已设置为封面");
				$("#coverImage").val(self.data("value"));
			}),$("a[rel='delete-picture']").live("click", function(c) {
				$(this).parents("li").remove();
			});
			return this;
		}
	};
};
ICMS.article_crud= function() {
	var ajaxurl = {
		renameURL : '/manager/business/article/attachment/rename',
		removeURL : '/manager/business/article/attachment/remove',
		downloadURL:'/manager/business/article/attachment/download?keyid='
	};
	return {		
		ready : function(){			
			$(".search_submit_form").validationEngine();
			$(".myform").validationEngine();
			return this;
		},
		edit: function(local){
			$(".picture-box").on("click", ".set-picture-header", function(c) {
				c.preventDefault();
				var self = $(this);
				self.parents(".picture-box").find(".set-picture-header").each(function() {
					$(this).removeClass("picture-header").text("设置为列表页封面")
				});				
				self.addClass("picture-header").text("已设置为封面");
				$("#coverImage").val(self.data("value"));
			}),$("a[rel='delete-picture']").live("click", function(c) {
				$(this).parents("li").remove();
				$("#img-upload").show();
			})
			,$("em[class='a-closePro']").live("click", function(c) {
				$(this).parent("span").remove();
			}),
			
			$(".attachment").live('dblclick',function(){
				var self = $(this);
				var input ="<input type='text' id='temp' data-value="+self.attr("data-value")+" value="+self.text()+" >";
				self.html(input);
				$("input#temp").focus();
				$("input").blur(function(){
					var nametxt=$(this).val();
					$.post(local+ ajaxurl.renameURL, {
						keyid: $(this).attr("data-value"),
						name:nametxt
					}, function(data) {
						if (data.type == 'SUCCESS') {					
							self.text(nametxt);
						}
					}).error(function() {
						$.alert('重命名文章附件名称失败!', '提示', function() {})
					});					
				});
				
			});
			
			
			$(".attachment-box>span>i.icon-remove").live('click',function(){
				$this=$(this);
				var alerttxt=$(this).siblings("label").first().text(),
				fileId = $(this).siblings("label").first().attr("data-value");
				$.confirm('确定移除“'+alerttxt+'“文章附件？', '温馨提示', function(result){
					if(result=='ok'){
						$.post(local+ ajaxurl.removeURL, {
							keyid: fileId
						}, function(data) {
							if (data.type == 'SUCCESS') {					
								$.success('删除文章附件成功!', '提示', function() {})
								$this.closest("span").remove();
							}
						}).error(function() {
							$.alert('删除文章附件失败!', '提示', function() {})
						});		
					}
				});

			});
			
			$(".attachment i.icon-download-alt").bind('click',function(){
				
			});
			
			return this;
		},
		
		
		add: function(){
			$(".picture-box").on("click", ".set-picture-header", function(c) {
				c.preventDefault();
				var self = $(this);
				self.parents(".picture-box").find(".set-picture-header").each(function() {
					$(this).removeClass("picture-header").text("设置为列表页封面")
				});				
				self.addClass("picture-header").text("已设置为封面");
				$("#coverImage").val(self.data("value"));
			}),$("a[rel='delete-picture']").live("click", function(c) {
				$(this).parents("li").remove();
				$("#img-upload").show();
			});
			return this;
		},
		attachment: function(local){
			$(".attachment").live('dblclick',function(){
				var self = $(this);
				var input ="<input type='text' id='temp' data-value="+self.attr("data-value")+" value="+self.text()+" >";
				self.html(input);
				$("input#temp").focus();
				$("input").blur(function(){
					var nametxt=$(this).val();
					$.post(local+ ajaxurl.renameURL, {
						keyid: $(this).attr("data-value"),
						name:nametxt
					}, function(data) {
						if (data.type == 'SUCCESS') {					
							self.text(nametxt);
						}
					}).error(function() {
						$.alert('重命名文章附件名称失败!', '提示', function() {})
					});					
				});
			});
			
			$(".attachment-box>span>i.icon-remove").live('click',function(){
				$this=$(this);
				var alerttxt=$(this).siblings("label").first().text();
				var alertid=$(this).siblings("label").first().attr("data-value");
				$.confirm('确定移除“'+alerttxt+'“文章附件？', '温馨提示', function(result){
					if(result=='ok'){						
						$.post(local+ ajaxurl.removeURL, {
							keyid:alertid
						}, function(data) {
							if (data.type == 'SUCCESS') {
								$this.closest("span").remove();
							}
						}).error(function() {
							$.alert('移除文章附件失败!', '提示', function() {});
						});
					}
				});
			});
			
			$(".attachment-box>span>i.icon-download-alt").bind('click',function(){
				var alertid=$(this).siblings("label").first().attr("data-value");
				window.location.href=local+ ajaxurl.downloadURL+alertid;
			});
			return this;
		}
	};
};

ICMS.setsystem.banner= function() {	
	var ajaxurl = {
			deleteURL:'/manager/setsystem/banner/delete'
	};
	return {		
		ready : function(){			
			$(".search_submit_form").validationEngine();
			$(".myform").validationEngine();
			return this;
		},
		commons:function(){
			$("a[rel='delete-picture']").live("click", function(c) {
				$(this).parents("li").remove();
				$("#img-upload").show();
			});
			
			return this;
		},
		list:function(local){
			$(".delete").each(function(index, item) {
				$(item).bind("click", function() {
					var $this = $(this);
					$.confirm('确认删除该横幅信息嘛？将彻底删除无法找回！', '温馨提示', function(result){
						if(result=='ok'){
							$.post(local + ajaxurl.deleteURL, {
								keyid: $this.attr("data-value")
							}, function(data) {
								$.alert(data.message, '提示', function() {});
								if (data.type == 'SUCCESS') {
									$this.parents("tr").remove();
									$(".totalCount").html($(".totalCount").html()-1);
								}
							}).error(function() {
								$.alert('删除该横幅信息失败!', '提示', function() {})
							});
						}
					});
				});
			});
			return this;
		}
	};
};

ICMS.business.article_crud= function() {
	var ajaxurl = {
			trashURL : '/manager/business/article/delete'
	};
	return {		
		ready : function(){			
			$(".search_submit_form").validationEngine();
			$(".myform").validationEngine();
			return this;
		},
		list:function(local){
			$(".icon-trash").each(function(index, item) {
				$(item).bind("click", function() {
					var $this = $(this);
					$.confirm('确认该文章放到文章回收站嘛？', '温馨提示', function(result){
						if(result=='ok'){
							$.post(local + ajaxurl.trashURL, {
								keyid: $this.attr("data-value")
							}, function(data) {
								$.alert(data.message, '提示', function() {});
								if (data.type == 'SUCCESS') {
									$this.parents("tr").remove();
								}
							}).error(function() {
								$.alert('该文章放到文章回收站失败!', '提示', function() {})
							});
						}
					});
				});
			});			
			return this;
		}
	};
};
ICMS.business.article.trash= function() {
	var ajaxurl = {
			undoURL : '/manager/business/article/trash/undo',
			deleteURL:'/manager/business/article/trash/delete'
	};
	return {		
		ready : function(){			
			$(".search_submit_form").validationEngine();
			$(".myform").validationEngine();
			return this;
		},
		list:function(local){
			$(".undo").each(function(index, item) {
				$(item).bind("click", function() {
					var $this = $(this);
					$.confirm('确认还原该文章信息嘛？', '温馨提示', function(result){
						if(result=='ok'){
							$.post(local + ajaxurl.undoURL, {
								keyid: $this.attr("data-value")
							}, function(data) {
								$.alert(data.message, '提示', function() {});
								if (data.type == 'SUCCESS') {
									$this.parents("tr").remove();
								}
							}).error(function() {
								$.alert('该文章还原该文章信息失败!', '提示', function() {})
							});
						}
					});
				});
			});
			$(".delete").each(function(index, item) {
				$(item).bind("click", function() {
					var $this = $(this);
					$.confirm('确认删除该文章信息嘛？将彻底删除无法找回！', '温馨提示', function(result){
						if(result=='ok'){
							$.post(local + ajaxurl.deleteURL, {
								keyid: $this.attr("data-value")
							}, function(data) {
								$.alert(data.message, '提示', function() {});
								if (data.type == 'SUCCESS') {
									$this.parents("tr").remove();
								}
							}).error(function() {
								$.alert('删除该文章信息失败!', '提示', function() {})
							});
						}
					});
				});
			});
			return this;
		}
	};
};

ICMS.business.article.classify= function() {
	var ajaxurl = {
			deleteURL:'/manager/business/article/classify/delete'
	};
	return {		
		ready : function(){			
			$(".search_submit_form").validationEngine();
			$(".myform").validationEngine();
			return this;
		},
		list:function(local){
			$(".delete").each(function(index, item) {
				$(item).bind("click", function() {
					var $this = $(this);
					$.confirm('确认删除该文章栏目信息嘛？将彻底删除无法找回！', '温馨提示', function(result){
						if(result=='ok'){
							$.post(local + ajaxurl.deleteURL, {
								keyid: $this.attr("data-value")
							}, function(data) {
								$.alert(data.message, '提示', function() {});
								if (data.type == 'SUCCESS') {
									$this.parents("tr").remove();
								}
							}).error(function() {
								$.alert('删除该文章栏目信息失败!', '提示', function() {})
							});
						}
					});
				});
			});
			return this;
		}
	};
};
ICMS.meta_crud= function() {
	return {		
		ready : function(){			
			$(".search_submit_form").validationEngine();
			$(".myform").validationEngine();
			return this;
		},
		
		edit: function(){
			$("a[rel='delete-picture']").live("click", function(c) {
				$(this).parents("li").parent().next().show();
				$(this).parents("li").parent().next().next().val("");
				$(this).parents("li").remove();
			});
			return this;
		}
	};
};

ICMS.setsystem.friendlinks= function() {
	var ajaxurl = {
			deleteURL:'/manager/setsystem/friendlylinks/delete'
	};
	return {		
		ready : function(){			
			$(".search_submit_form").validationEngine();
			$(".myform").validationEngine();
			return this;
		},
		commons:function(){
			$("a[rel='delete-picture']").live("click", function(c) {
				$(this).parents("li").remove();
				$("#img-upload").show();
			});
			
			return this;
		},
		list:function(local){
			$(".delete").each(function(index, item) {
				$(item).bind("click", function() {
					var $this = $(this);
					$.confirm('确认删除该友情链接信息嘛？将彻底删除无法找回！', '温馨提示', function(result){
						if(result=='ok'){
							$.post(local + ajaxurl.deleteURL, {
								keyid: $this.attr("data-value")
							}, function(data) {
								$.alert(data.message, '提示', function() {});
								if (data.type == 'SUCCESS') {
									$this.parents("tr").remove();
									$(".totalCount").html($(".totalCount").html()-1);
								}
							}).error(function() {
								$.alert('删除该友情链接信息失败!', '提示', function() {})
							});
						}
					});
				});
			});
			return this;
		}
	};
};



ICMS.template_crud= function() {
	return {		
		ready : function(){			
			$(".myform").validationEngine();
			return this;
		}	
	};
};

ICMS.system.footer_crud= function() {
	return {		
		ready : function(){
			$(".myform").validationEngine();
			return this;
		},
		add: function(){
			$(".btn-num").on("click",function(c) {
				c.preventDefault();
				var oLi = $('<li><label>名称：</label><input type="text" name="names" class="input-small validate[required,maxSize[50]]"><label class="ml10">链接：</label> <input type="text" name="urls" class="input-xlarge validate[required,maxSize[225]]"><label class="ml10"> <i class="icon-remove plus_delete pointer_hand" title="删除"></i>');
				$(this).parent().next().find('.rule-score').append(oLi);
				$(".myform").validationEngine();
			}),$(".remove-btn").live("click", function(c) {
				$(this).parent('li').remove();
			}),$(".plus_delete").live("click",function(c) {
				$(this).parent('li').remove();
			});
			return this;
		}
	};
};


ICMS.security.role= function() {
	var ajaxurl = {
		loadPermissions : '/manager/security/role/loadPermissions?roleid='
	};

	return {
		ready : function(){
			return this;
		},		
		list : function(local){
			$("table#item-table a#setPermissions").each(function(index,item){
                $(item).bind("click",function(){
    				var $this = $(this);
    				var roleid=$this.attr("data-value");
					
    				$("input[name='roleid']").attr("value",roleid);
    				var url=local+ajaxurl.loadPermissions+roleid;
					$.getJSON(url, function(data){
						$.each(data, function(i,item){
							$(":checkbox[value='"+item.id+"']").prop('checked',true);
							$.uniform.update(":checkbox[value='"+item.id+"']");
						});
					});
    				$("#set_permissions_modal").modal()
    								.find("strong#beautiful_pjname").text($this.attr("data-name"))
    								.parent().find("input#keyid").attr("value",$this.attr("keyid"));
                 });
	        });
			$('#set_permissions_modal').on('hide.bs.modal', function () {
				$(":checkbox[name='permission_id']").prop('checked',false);
				$.uniform.update(":checkbox[name='permission_id']");
            });
			return this;
		}
	};
};